<%# --- 1. 結果表示画面（正解後） --- %>
<% if @show_result %>
  <div style="text-align: center; padding: 50px; background: #121212; min-height: 100vh;" class="fade-in">
    <h1 style="font-size: 5rem; color: #ffca28;">✨ 正解！！ ✨</h1>
    <div style="background: #1e1e1e; padding: 40px; border-radius: 30px; border: 5px solid #03dac6; margin: 20px;">
      <p style="font-size: 2rem; color: #fff;">今日の獲得ポイント</p>
      <p style="font-size: 4rem; color: #03dac6; font-weight: bold;">+<%= @earned_points %> pt</p>
      
      <hr style="border-color: #333; margin: 30px 0;">
      
      <p style="font-size: 1.5rem; color: #aaa;">出発（7:20）まで あと</p>
      <p style="font-size: 3.5rem; color: #ff9800; font-weight: bold;"><%= @minutes_left %> 分</p>
    </div>
    <%= link_to 'トップに戻る', root_path, style: "display: inline-block; margin-top: 30px; color: #bb86fc; font-size: 1.5rem; text-decoration: none; border: 2px solid #bb86fc; padding: 15px 30px; border-radius: 15px;" %>
  </div>

<%# --- 2. クイズ中またはタスク中の画面 --- %>
<% elsif @all_done %>
  <div id="main-container">
    <div id="quiz-section" style="background: #1e1e1e; padding: 30px; border-radius: 20px; border: 4px solid #bb86fc; margin: 20px;">
      <p style="font-size: 1.5rem; font-weight: bold; color: #fff;">【時間 クイズ】</p>
      
      <%# 出発時刻 7:20 を過ぎた時に自動でここを隠すためのID %>
      <div id="active-quiz">
        <p style="font-size: 1.5rem; color: #fff;">
          <span style="color: #4FC3F7;"><%= @start_time_display %></span> から 
          <span style="color: #ffca28;"><%= @end_time_display %></span> までは
        </p>
        <p style="font-size: 1.8rem; color: #ff9800; font-weight: bold;">何時間 何分 かな？</p>

        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
          <input type="number" id="user-hour" placeholder="0" style="width: 100px; font-size: 3rem; text-align: center; background: #fff; color: #000; border-radius: 10px;">
          <span style="font-size: 1.5rem; color: #fff;">時間</span>
          <input type="number" id="user-min" placeholder="00" style="width: 120px; font-size: 3rem; text-align: center; background: #fff; color: #000; border-radius: 10px;">
          <span style="font-size: 1.5rem; color: #fff;">分</span>
        </div>
        <br>
        <button type="button" onclick="checkAnswer()" style="width: 80%; padding: 20px; font-size: 1.5rem; background-color: #2196F3; color: white; border-radius: 15px; border: none;">答え合わせ！</button>
      </div>

      <%# 7:20を過ぎた時に自動で表示する警告エリア %>
      <div id="late-warning" style="display: none;">
        <div style="background-color: #fff9c4; padding: 20px; border-radius: 15px; border: 5px solid #fbc02d;">
          <p style="font-size: 2.2rem; color: #000; font-weight: bold; margin: 0;">
            7:20を 過ぎています！<br>
            急いで 出発 しましょう！
          </p>
        </div>
        <p style="margin-top: 20px; font-size: 1.5rem; color: #ffca28;">現在の合計: <%= @user_score.score %> pt</p>
      </div>
    </div>
  </div>

  <script>
    let attemptCount = 0;

    // --- リアルタイム時間チェック機能 ---
    function checkCurrentTime() {
      const now = new Date();
      // 日本時間で 7:20 を判定
      const limit = new Date();
      limit.setHours(7, 20, 0);

      if (now > limit) {
        document.getElementById('active-quiz').style.display = 'none';
        document.getElementById('late-warning').style.display = 'block';
      }
    }
    setInterval(checkCurrentTime, 1000); // 1秒ごとにチェック

    window.checkAnswer = function() {
      attemptCount++;
      const correctTotalMin = <%= @correct_total_minutes %>;
      const hInput = document.getElementById('user-hour').value || 0;
      const mInput = document.getElementById('user-min').value || 0;
      const userTotalMin = parseInt(hInput) * 60 + parseInt(mInput);
      
      if (userTotalMin === correctTotalMin) {
        let getPoint = 0;
        // 回答時に7:20を過ぎていないかチェック
        if (new Date() < new Date().setHours(7, 20, 0)) {
          if (attemptCount === 1) getPoint = 50;
          else if (attemptCount === 2) getPoint = 30;
          else if (attemptCount === 3) getPoint = 10;
        }

        // ポイント加算用の隠しフォームを送信
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '<%= add_points_tasks_path %>';
        const token = document.querySelector('meta[name="csrf-token"]').content;
        
        form.innerHTML = `
          <input type="hidden" name="authenticity_token" value="${token}">
          <input type="hidden" name="points" value="${getPoint}">
        `;
        document.body.appendChild(form);
        form.submit();
      } else {
        const msg = document.getElementById('result-message');
        msg.innerText = "残念！ もう一度 考えてみよう";
        msg.style.color = "#888";
      }
    };
  </script>
<% end %>